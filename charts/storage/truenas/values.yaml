# Cluster configuration
cluster:
  name: cluster
  top_level_domain: roybales.com
  storage:
    truenas:
      # Driver configuration
      driver: freenas-iscsi
      instance_id: ""

      # TrueNAS HTTP/API connection
      httpConnection:
        protocol: https
        host: truenas.roybales.com
        port: 443
        # use only 1 of apiKey or username/password
        # if both are present, apiKey is preferred
        # apiKey is only available starting in TrueNAS-12
        #apiKey: TRUENAS_API_KEY
        username: admin
        password: TRUENAS_PASSWORD
        allowInsecure: true
        # use apiVersion 2 for TrueNAS-12 and up (will work on 11.x in some scenarios as well)
        # leave unset for auto-detection
        apiVersion: 2

      # SSH connection for democratic-csi
      sshConnection:
        host: truenas.roybales.com
        port: 22
        username: admin
        # use either password or privateKey
        password: TRUENAS_SSH_PASSWORD
        privateKey: ""

      # ZFS configuration
      zfs:
        # can be used to override defaults if necessary
        # the example below is useful for TrueNAS 12
        cli:
          sudoEnabled: true
          paths:
            zfs: /usr/sbin/zfs
            zpool: /usr/sbin/zpool
            sudo: /usr/bin/sudo
            chroot: /usr/sbin/chroot

        # can be used to set arbitrary values on the dataset/zvol
        # can use handlebars templates with the parameters from the storage class/CO
        #datasetProperties:
        #  "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"

        # total volume name (zvol/<datasetParentName>/<pvc name>) length cannot exceed 63 chars
        # standard volume naming overhead is 46 chars
        # datasetParentName should therefore be 17 chars or less when using TrueNAS 12 or below
        datasetParentName: "volume1/test/vols"
        # do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
        # do NOT comment this option out even if you don't plan to use snapshots
        detachedSnapshotsDatasetParentName: "volume1/test/snaps"
        # "" (inherit), lz4, gzip-9, etc
        zvolCompression: "lz4"
        # "" (inherit), on, off, verify
        zvolDedup: "off"
        zvolEnableReservation: false
        # 512, 1K, 2K, 4K, 8K, 16K, 64K, 128K default is 16K
        zvolBlocksize: "16K"

      # iSCSI configuration
      iscsi:
        targetPortal: "truenas.roybales.com:3260"
        # for multipath
        targetPortals: []
        # leave empty to omit usage of -I with iscsiadm
        interface: ""

        # MUST ensure uniqueness
        # full iqn limit is 223 bytes, plan accordingly
        # default is "{{ name }}"
        #nameTemplate: "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}-{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
        namePrefix: "test-"
        nameSuffix: ""

        # add as many as needed
        targetGroups:
          # get the correct ID from the "portal" section in the UI
          - targetGroupPortalGroup: 1
            # get the correct ID from the "initiators" section in the UI
            targetGroupInitiatorGroup: 1
            # None, CHAP, or CHAP Mutual
            targetGroupAuthType: None
            # get the correct ID from the "Authorized Access" section of the UI
            # only required if using CHAP
            targetGroupAuthGroup: ""

        #extentCommentTemplate: "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
        extentInsecureTpc: true
        extentXenCompat: false
        extentDisablePhysicalBlocksize: true
        # 512, 1024, 2048, or 4096
        extentBlocksize: 512
        # "" (let FreeNAS decide, currently defaults to SSD), Unknown, SSD, 5400, 7200, 10000, 15000
        extentRpm: "SSD"
        # 0-100 (0 == ignore)
        extentAvailThreshold: 0

      # Infisical secret key names
      secretKeys:
        apiKey: TRUENAS_API_KEY
        sshPassword: TRUENAS_SSH_PASSWORD
        truenasPassword: TRUENAS_PASSWORD

# Democratic CSI Driver configuration
democratic-csi:
  csiDriver:
    name: "org.democratic-csi.truenas-iscsi"

  storageClasses:
    - name: truenas-iscsi
      defaultClass: true
      reclaimPolicy: Delete
      volumeBindingMode: Immediate
      allowVolumeExpansion: true
      parameters:
        csi.storage.k8s.io/fstype: ext4
      mountOptions: []
      secrets:
        provisioner-secret:
        controller-publish-secret:
        node-stage-secret:
        node-publish-secret:
        controller-expand-secret:

  volumeSnapshotClasses:
    - name: truenas-iscsi
      annotations:
        k10.kasten.io/is-snapshot-class: "true"
      deletionPolicy: Delete
      parameters:
      secrets:
        snapshotter-secret:

  controller:
    rbac:
      openshift:
        privileged: true
    driver:
      image:
        repository: democraticcsi/democratic-csi
        tag: next@sha256:6b758d6faf96f0e96d4b8ac0e240fc290c7bace23c20d78a3eb93781652cb1f1
        pullPolicy: IfNotPresent
    externalAttacher:
      enabled: true
      image:
        registry: registry.k8s.io/sig-storage/csi-attacher
        tag: v4.6.1
    externalResizer:
      enabled: true
    externalSnapshotter:
      enabled: true

  node:
    rbac:
      openshift:
        privileged: true

  driver:
    existingConfigSecret: democratic-csi-truenas-config
    config:
      # This section is overridden by the ExternalSecret
      driver: freenas-iscsi
